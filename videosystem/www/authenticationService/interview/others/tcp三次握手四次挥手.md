在 TCP 协议中，三次握手和四次挥手是建立和断开连接的关键过程，其中涉及的报文字段在这两个过程中扮演了核心角色。下面详细列出了在三次握手和四次挥手过程中各个阶段发送的报文字段。

### TCP 三次握手

**目的**：建立一个可靠的连接。

#### 第一次握手（发起连接）
- **SYN=1**: 设置 SYN 标志位为 1，表示这是一个连接请求。
- **seq=x**: 设置序列号为 x，表示从这个号码开始传输数据。

#### 第二次握手（响应连接）
- **SYN=1**: 再次设置 SYN 标志位为 1，响应连接请求。
- **ACK=1**: 设置 ACK 标志位为 1，表示对方的 SYN 已被确认。
- **seq=y**: 设置序列号为 y，服务器端选择的序列号。
- **ack=x+1**: 确认号设置为 x+1，表示客户端的 SYN 已被接收，且期待收到从序号 x+1 开始的数据。

#### 第三次握手（确认连接）
- **ACK=1**: 设置 ACK 标志位为 1，表示对方的 SYN 已被确认。
- **seq=x+1**: 客户端继续使用上次的序列号。
- **ack=y+1**: 客户端确认服务器的 SYN，并期待从序号 y+1 开始接收数据。

### TCP 四次挥手

**目的**：断开已建立的连接。

#### 第一次挥手（发起关闭）
- **FIN=1**: 设置 FIN 标志位为 1，表示发起方已经没有数据发送，希望关闭连接。
- **seq=x**: 发起方的当前序列号。

#### 第二次挥手（确认关闭请求）
- **ACK=1**: 设置 ACK 标志位为 1，确认接收到对方的 FIN。
- **seq=y**: 接收方的当前序列号。
- **ack=x+1**: 确认号为 x+1，表示对方的 FIN 已被接收。

#### 第三次挥手（发起另一端的关闭）
- **FIN=1**: 接收方也设置 FIN 标志位，表示没有数据要发送，希望关闭连接。
- **seq=y**: （如果之前有传输数据，这里的 y 可能会变）。
- **ack=x+1**: 保持 ack 值不变，表示继续确认对方的 FIN。

#### 第四次挥手（结束确认）
- **ACK=1**: 设置 ACK 标志位，确认对方的 FIN。
- **seq=x+1**: 维持上一次的序列号。
- **ack=y+1**: 最终确认号，表示对方的 FIN 已被接收。

### 总结
这些 TCP 报文中的字段，特别是序列号（seq）、确认号（ack）、SYN、ACK 和 FIN 标志，都在 TCP 的连接建立和断开过程中起着至关重要的作用。它们确保了 TCP 连接的可靠性和顺序性，以及在结束通信时的正确性。





### cat /etc/sysctl.conf

为了提高服务器的 TCP 并发量，可以调整 `sysctl.conf` 中的几个参数。下面提供了一些基本的调整方法，这些方法可以帮助你提升系统处理高并发 TCP 连接的能力。请记得在修改配置后执行 `sysctl -p` 命令来使改动立即生效。

### 1. 增加 TCP 最大 SYN 后备队列大小
`tcp_max_syn_backlog` 参数定义了等待处理的 SYN 连接请求的队列的最大长度。增加这个值可以让服务器处理更多的并发连接尝试。

```conf
net.ipv4.tcp_max_syn_backlog = 4096
```

### 2. 增加 TCP 时延回收桶的数量
`tcp_max_tw_buckets` 参数限制了系统中时间等待套接字的最大数量。增加此参数可以减少因为超出限制而被强制关闭的连接。

```conf
net.ipv4.tcp_max_tw_buckets = 20000
```

### 3. 修改文件描述符限制
在 Linux 系统中，每个进程都有一个限制，即它可以打开的最大文件描述符数，这也影响到可以打开的套接字数量。编辑 `/etc/security/limits.conf` 文件，增加以下内容：

```conf
* soft nofile 100000
* hard nofile 100000
```

### 4. 调整 TCP keepalive 设置
如果你的服务器需要维护大量长时间开放的连接，合理设置 TCP keepalive 参数可以帮助管理这些连接。

```conf
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 10
net.ipv4.tcp_keepalive_intvl = 60
```

### 5. 调整 TCP 内存缓冲区大小
这些参数调整 TCP 套接字使用的内存缓冲区的大小，这对于高负载的服务器来说非常重要。

```conf
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
```

### 6. 开启 TCP 快速打开
TCP 快速打开可以减少建立连接所需的往返时延。

```conf
net.ipv4.tcp_fastopen = 3
```

### 应用修改
修改 `sysctl.conf` 文件后，运行以下命令以使配置立即生效：

```bash
sysctl -p
```

### 注意事项
- **备份**: 在修改系统配置前，务必备份当前的配置文件。
- **测试**: 修改配置后，进行适当的测试以确保修改没有引入不期望的副作用。
- **监控**: 持续监控系统性能和资源使用情况，确保系统稳定运行。

这些调整可以帮助提高 TCP 并发处理能力，但最终效果还取决于服务器的硬件配置、网络环境和具体应用场景。如果调整后仍旧无法满足需求，可能需要考虑升级硬件或优化应用架构。